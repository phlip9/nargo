/*
anyhow-custom-build>

NIX_BUILD_CORES=12
depsHostHost=
src=/nix/store/ppw97p0r7h5wk5y83xaw4ylqvrvkrqwk-crate-anyhow-1.0.86
out=/nix/store/dg8ic8rg6ggxbhv53h4yif4alqfiph2y-anyhow-custom-build-1.0.86
version=1.0.86
NIX_BUILD_TOP=/build
TMPDIR=/build

SHELL=/nix/store/717iy55ncqs0wmhdkwc5fg2vci5wbmq8-bash-5.2p32/bin/bash
NIX_BUILD_CORES=12
configureFlags=
mesonFlags=
shell=/nix/store/717iy55ncqs0wmhdkwc5fg2vci5wbmq8-bash-5.2p32/bin/bash
depsHostHost=
STRINGS=strings
src=/nix/store/ppw97p0r7h5wk5y83xaw4ylqvrvkrqwk-crate-anyhow-1.0.86
depsTargetTarget=
stdenv=/nix/store/ncv68hjnidcd2bm5abkhklrijhn0cgn6-stdenv-linux
builder=/nix/store/717iy55ncqs0wmhdkwc5fg2vci5wbmq8-bash-5.2p32/bin/bash
phases=buildPhase
PWD=/build
SOURCE_DATE_EPOCH=315532800
pname=anyhow-custom-build
NIX_ENFORCE_NO_NATIVE=1
CXX=g++
TEMPDIR=/build
system=x86_64-linux
TZ=UTC
HOST_PATH=/nix/store/ph44jcx3ddmlwh394mh1wb7f1qigxqb1-coreutils-9.5/bin:/nix/store/yb8icljkwhk5lla4nci3myndq2m4ywly-findutils-4.10.0/bin:/nix/store/phqahkhjsk8sl2jjiid1d47l2s4wy33h-diffutils-3.10/bin:/nix/store/yd9vbyhbxx62j0cyhd6v0iacz11nxpvc-gnused-4.9/bin:/nix/store/lvnwdmnjm7nvaq0a3vhvvn46iy4ql7gr-gnugrep-3.11/bin:/nix/store/0np7q7np75csai2cwzx57n332vn9ig4i-gawk-5.2.2/bin:/nix/store/zvn9bvrl2g516d2hfnanljiw24qa6w8l-gnutar-1.35/bin:/nix/store/db379c3zrmncmbv5khqxpk6ggbhxjw61-gzip-1.13/bin:/nix/store/girfp68w14pxfii52ak8gcs212y4q2s2-bzip2-1.0.8-bin/bin:/nix/store/21y3gqgm2a3w94m0wcrz1xxshks80z7p-gnumake-4.4.1/bin:/nix/store/717iy55ncqs0wmhdkwc5fg2vci5wbmq8-bash-5.2p32/bin:/nix/store/91ixz3zw9ipc5j93gybir9fp5mzisq8w-patch-2.7.6/bin:/nix/store/6v73xwg2c7p5ap29ckyg18ng87pzlnxs-xz-5.6.2-bin/bin:/nix/store/a6nsbir3y5ni3wwkw933aqvcmyyywnnz-file-5.45/bin
doInstallCheck=
HOME=/homeless-shelter
NIX_BINTOOLS=/nix/store/l7n97992gd5piaw8phkxzsz176gfk1yj-binutils-wrapper-2.43.1
GZIP_NO_TIMESTAMPS=1
depsTargetTargetPropagated=
cmakeFlags=
NIX_SSL_CERT_FILE=/no-cert-file.crt
version=1.0.86
outputs=out
NIX_STORE=/nix/store
TMPDIR=/build
LD=ld
NIX_ENFORCE_PURITY=1
buildPhase= ...
READELF=readelf
doCheck=
NIX_LOG_FD=2
depsBuildBuild=/nix/store/csadsvzmnzvb952kjky9ziinky5q8abr-rustc-wrapper-1.81.0 /nix/store/57w1j7l0qm47qirpzv94d3qlmr6a9qj1-nargo-rustc-0.1.0
TERM=xterm-256color
SIZE=size
propagatedNativeBuildInputs=
strictDeps=
AR=ar
AS=as
TEMP=/build
NIX_BINTOOLS_WRAPPER_TARGET_HOST_x86_64_unknown_linux_gnu=1
SHLVL=1
NIX_BUILD_TOP=/build
NM=nm
NIX_CFLAGS_COMPILE= -frandom-seed=dg8ic8rg6g
patches=
buildInputs=
SSL_CERT_FILE=/no-cert-file.crt
depsBuildTarget=
OBJCOPY=objcopy
out=/nix/store/dg8ic8rg6ggxbhv53h4yif4alqfiph2y-anyhow-custom-build-1.0.86
STRIP=strip
XDG_DATA_DIRS=/nix/store/dvfb5mrpfhg5211v6pl0a3fmz9idg6w7-patchelf-0.15.0/share
TMP=/build
OBJDUMP=objdump
PATH=/nix/store/csadsvzmnzvb952kjky9ziinky5q8abr-rustc-wrapper-1.81.0/bin:/nix/store/57w1j7l0qm47qirpzv94d3qlmr6a9qj1-nargo-rustc-0.1.0/bin:/nix/store/dvfb5mrpfhg5211v6pl0a3fmz9idg6w7-patchelf-0.15.0/bin:/nix/store/vh9fsdhgxcnab2qk7vdp2palkkn6j3cp-gcc-wrapper-13.3.0/bin:/nix/store/0vsyw5bhwmisszyfd1a0sdnwvnf4qa5a-gcc-13.3.0/bin:/nix/store/vpsla1ivhavzd4fmi95yzmgb4g9rd072-glibc-2.40-36-bin/bin:/nix/store/ph44jcx3ddmlwh394mh1wb7f1qigxqb1-coreutils-9.5/bin:/nix/store/l7n97992gd5piaw8phkxzsz176gfk1yj-binutils-wrapper-2.43.1/bin:/nix/store/vcvhwiilizhijk7ywyn58p9l005n9sbn-binutils-2.43.1/bin:/nix/store/ph44jcx3ddmlwh394mh1wb7f1qigxqb1-coreutils-9.5/bin:/nix/store/yb8icljkwhk5lla4nci3myndq2m4ywly-findutils-4.10.0/bin:/nix/store/phqahkhjsk8sl2jjiid1d47l2s4wy33h-diffutils-3.10/bin:/nix/store/yd9vbyhbxx62j0cyhd6v0iacz11nxpvc-gnused-4.9/bin:/nix/store/lvnwdmnjm7nvaq0a3vhvvn46iy4ql7gr-gnugrep-3.11/bin:/nix/store/0np7q7np75csai2cwzx57n332vn9ig4i-gawk-5.2.2/bin:/nix/store/zvn9bvrl2g516d2hfnanljiw24qa6w8l-gnutar-1.35/bin:/nix/store/db379c3zrmncmbv5khqxpk6ggbhxjw61-gzip-1.13/bin:/nix/store/girfp68w14pxfii52ak8gcs212y4q2s2-bzip2-1.0.8-bin/bin:/nix/store/21y3gqgm2a3w94m0wcrz1xxshks80z7p-gnumake-4.4.1/bin:/nix/store/717iy55ncqs0wmhdkwc5fg2vci5wbmq8-bash-5.2p32/bin:/nix/store/91ixz3zw9ipc5j93gybir9fp5mzisq8w-patch-2.7.6/bin:/nix/store/6v73xwg2c7p5ap29ckyg18ng87pzlnxs-xz-5.6.2-bin/bin:/nix/store/a6nsbir3y5ni3wwkw933aqvcmyyywnnz-file-5.45/bin
propagatedBuildInputs=
CC=gcc
NIX_CC=/nix/store/vh9fsdhgxcnab2qk7vdp2palkkn6j3cp-gcc-wrapper-13.3.0
depsBuildTargetPropagated=
depsBuildBuildPropagated=
NIX_CC_WRAPPER_TARGET_HOST_x86_64_unknown_linux_gnu=1
CONFIG_SHELL=/nix/store/717iy55ncqs0wmhdkwc5fg2vci5wbmq8-bash-5.2p32/bin/bash
__structuredAttrs=
RANLIB=ranlib
NIX_HARDENING_ENABLE=bindnow format fortify fortify3 pic relro stackprotector strictoverflow zerocallusedregs
NIX_LDFLAGS=-rpath /nix/store/dg8ic8rg6ggxbhv53h4yif4alqfiph2y-anyhow-custom-build-1.0.86/lib
nativeBuildInputs=
name=anyhow-custom-build-1.0.86
depsHostHostPropagated=
_=/nix/store/57w1j7l0qm47qirpzv94d3qlmr6a9qj1-nargo-rustc-0.1.0/bin/nargo-rustc
*/

use std::{
    ffi::{OsStr, OsString},
    path::Path,
    str::FromStr,
};

use crate::run;
use nargo_core::{env, logger, trace};

pub struct ArgsRaw {
    pub(crate) build_script_dep: OsString,
    pub(crate) crate_type: String,
    pub(crate) dep_crate_names: String,
    pub(crate) dep_names: String,
    pub(crate) dep_paths: OsString,
    pub(crate) edition: String,
    pub(crate) features: String,
    pub(crate) kind: String,
    pub(crate) log: String,
    pub(crate) out: OsString,
    pub(crate) pkg_name: String,
    pub(crate) src: OsString,
    pub(crate) target_name: String,
    pub(crate) target_path: OsString,
    pub(crate) target_triple: String,
    pub(crate) version: String,
}

#[derive(Debug)] // TODO(phlip9): remove
pub struct Args<'a> {
    pub(crate) build_script_dep: Option<&'a Path>,
    pub(crate) crate_type: &'a str,
    pub(crate) deps: Vec<Dep<'a>>,
    pub(crate) edition: &'a str,
    pub(crate) features: &'a str,
    pub(crate) kind: &'a str,
    pub(crate) log: logger::Level,
    pub(crate) out: &'a Path,
    pub(crate) pkg_name: &'a str,
    pub(crate) src: &'a Path,
    pub(crate) target_name: &'a str,
    pub(crate) target_path: &'a Path,
    pub(crate) target_triple: &'a str,
    pub(crate) version: semver::Version,
}

#[derive(Debug)] // TODO(phlip9): remove
pub struct Dep<'a> {
    pub(crate) crate_name: &'a str,
    pub(crate) dep_name: &'a str,
    pub(crate) out: &'a Path,
}

impl ArgsRaw {
    pub fn from_env() -> Self {
        Self {
            build_script_dep: env::var_os("BUILD_SCRIPT_DEP").unwrap(),
            crate_type: env::var("CRATE_TYPE").unwrap(),
            dep_names: env::var("DEP_NAMES").unwrap(),
            dep_crate_names: env::var("DEP_CRATE_NAMES").unwrap(),
            dep_paths: env::var_os("DEP_PATHS").unwrap(),
            edition: env::var("EDITION").unwrap(),
            features: env::var("FEATURES").unwrap(),
            kind: env::var("KIND").unwrap(),
            log: env::var("LOG").unwrap(),
            out: env::var_os("out").unwrap(),
            pkg_name: env::var("PKG_NAME").unwrap(),
            src: env::var_os("src").unwrap(),
            target_name: env::var("TARGET_NAME").unwrap(),
            target_path: env::var_os("TARGET_PATH").unwrap(),
            target_triple: env::var("TARGET_TRIPLE").unwrap(),
            version: env::var("version").unwrap(),
        }
    }

    /// Clear all nargo-specific envs.
    ///
    /// # Safety
    ///
    /// [`std::env::remove_var`] is not thread-safe. You must call this before
    /// spawning any threads.
    pub unsafe fn remove_nargo_envs() {
        const REMOVE_ENVS: &[&str] = &[
            "BUILD_SCRIPT_DEP",
            "CRATE_TYPE",
            "DEP_NAMES",
            "DEP_CRATE_NAMES",
            "DEP_PATHS",
            "EDITION",
            "FEATURES",
            "KIND",
            "LOG",
            "out",
            "PKG_NAME",
            "src",
            "TARGET_NAME",
            "TARGET_PATH",
            "TARGET_TRIPLE",
            "version",
        ];

        for env in REMOVE_ENVS {
            std::env::remove_var(env);
        }
    }
}

impl<'a> Args<'a> {
    pub fn from_raw(args: &'a ArgsRaw) -> Self {
        let build_script_dep = if args.build_script_dep.is_empty() {
            None
        } else {
            Some(Path::new(&args.build_script_dep))
        };

        let version = args.version.as_str();
        let version = semver::Version::parse(version)
            .map_err(|err| {
                format!("version env ({version}) is not valid semver: {err}")
            })
            .unwrap();

        let log = logger::Level::from_str(&args.log).expect("invalid LOG env");

        Self {
            build_script_dep,
            crate_type: &args.crate_type,
            deps: parse_deps(
                &args.dep_names,
                &args.dep_crate_names,
                &args.dep_paths,
            ),
            edition: &args.edition,
            features: &args.features,
            kind: &args.kind,
            log,
            out: Path::new(&args.out),
            pkg_name: &args.pkg_name,
            src: Path::new(&args.src),
            target_name: &args.target_name,
            target_path: Path::new(&args.target_path),
            target_triple: &args.target_triple,
            version,
        }
    }

    pub fn run(self) {
        logger::set_level(self.log);

        trace!("args: {self:#?}");

        run::BuildContext::from_args(self).run()
    }

    pub fn label(&self) -> String {
        let pkg_name = self.pkg_name;
        let version = &self.version;
        let kind = self.kind;
        format!("{pkg_name}-{version}-{kind}")
    }
}

fn parse_deps<'a>(
    dep_names: &'a str,
    dep_crate_names: &'a str,
    dep_paths: &'a OsStr,
) -> Vec<Dep<'a>> {
    if dep_names.is_empty()
        && dep_crate_names.is_empty()
        && dep_paths.is_empty()
    {
        return Vec::new();
    }

    assert!(
        !dep_names.is_empty()
            && !dep_crate_names.is_empty()
            && !dep_paths.is_empty()
    );

    let mut dep_names = dep_names.split(' ');
    let mut dep_crate_names = dep_crate_names.split(' ');
    let mut dep_paths = dep_paths.as_encoded_bytes().split(|b| *b == b' ');

    let mut deps = Vec::new();

    loop {
        match (dep_names.next(), dep_crate_names.next(), dep_paths.next()) {
            (Some(dep_name), Some(crate_name), Some(path)) => {
                #[cfg(unix)]
                let path =
                    <OsStr as std::os::unix::ffi::OsStrExt>::from_bytes(path);

                #[cfg(not(unix))]
                let path = todo!();

                deps.push(Dep {
                    dep_name,
                    crate_name,
                    out: Path::new(path),
                });
            }
            (None, None, None) => break deps,
            _ => panic!("DEP_NAMES, DEP_CRATE_NAMES, and DEP_PATHS are uneven"),
        };
    }
}
